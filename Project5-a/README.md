## Project 5(a): SM2软件实现和优化
### 原理
SM2是我国国家密码管理局颁布的商用公钥密码标准算法的一种，它本质是一组椭圆曲线密码算法。由于其加密流程的复杂性，SM2的实现往往需要与SM3进行结合，使用SM3辅助其完成密钥派生KDF和消息完整性校验HASH过程。

其加密算法大致流程如下：

1、密钥产生，接收方B密钥取{1,2,...,n-1}的一个随机数d，其公钥 $P_{B}$ 便为椭圆曲线上的点 $d \cdot G$ ( $G = G(x,y)$ 为一个基点)。

2、假定发送方为A，A要发送消息M，长度为nlen

3、从{1,2,...,n-1}中选择随机数k

4、计算椭圆曲线点 $C_{1}=k \cdot G=(x_{1},y_{1})$

5、再计算点 $S=h \cdot P_{B}$

6、最后计算椭圆曲线点 $k \cdot P_{B}=(x_{1},x_{2})$

7、在上述椭圆曲线点得出的情况下，计算 $t=KDF(x_{2} \parallel y_{2},nlen)$

8、计算 $C_{2}=M \oplus t$

9、进而计算 $C_{3}=Hash(x_{2} \parallel M \parallel y_{2})$

10、最终输出密文 $C=(C_{1},C_{2},C_{3})$
### 代码思路
首先我们实现前置的SM3摘要生成部分，此部分包括置换函数P0()和P1()，循环左移函数move()以及三个布尔函数TT()(根据索引返回常量值)、FF()和GG()(两个用于压缩的函数)。

之后需要定义填充和消息扩展函数，用于对数据进行填充并将输入的数据拆分成组，并使用置换函数和move()函数对其进行扩展，得到多个32位整数。

到此SM2前置所需的SM3部分基本完成，现在构建椭圆曲线算法，第一步先定义曲线的参数，包括曲线方程的系数，基点G的坐标，私钥d等(这些部分参照标准参数定义)。

第二部定义基本的曲线计算函数，如点加法、双倍一些辅助函数。其中，置换函数用于对数据进行置换操作，LS函数用于逻辑左移操作，Ti函数根据索引返回常量值，Fi和Gi函数是压缩函数中的一部分，用于计算状态更新时的中间结果。

然后定义了padding函数，用于对数据进行填充，使其长度满足SHA-256算法的要求。

Extend函数将输入的数据B拆分成多个32位整数，并使用P1和LS函数对其进行扩展，得到额外的52个32位整数。

unsignedint_to_str函数用于将无符号整数转换为16进制字符串。

update函数是SHA-256算法的核心部分，实现了消息扩展和状态更新的过程。

Hash函数是SHA-256算法的入口函数，接收输入的消息m，进行填充、消息扩展和状态更新，最终返回更新后的初始向量IV。

KDF函数实现了密钥派生函数，根据输入的种子z和密钥长度klen生成密钥。（这一步也是SM2结合RFC6979的关键）

encrypt函数用于对消息m进行加密，首先将消息转换为二进制字符串，并进行填充，然后生成一个随机数k，并使用椭圆曲线乘法计算公钥点(x2, y2)，再使用KDF函数生成密钥t，将密钥与消息进行异或运算得到密文c2，最后生成MAC值c3。

